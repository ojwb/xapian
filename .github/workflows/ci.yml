name: CI

# Use bash by default on all platforms.
defaults:
  run:
    shell: bash

on:
  push:
    paths-ignore:
      - '.appveyor.yml'
      - NEWS
      - 'xapian-maintainer-tools/**'
  pull_request:
    branches: master
    paths-ignore:
      - '.appveyor.yml'
      - NEWS
      - 'xapian-maintainer-tools/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  makedist:
    name: 'make dist'
    runs-on: 'ubuntu-latest'
    env:
      LIBEXTRACTOR_PREFIX: '/usr/lib/x86_64-linux-gnu/libextractor'
    steps:
    - name: Check out repository code
      uses: actions/checkout@v4
      with:
        show-progress: false
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
    - name: Cache bootstrap tools
      uses: actions/cache@v4
      with:
        path: |
          BUILD
          INST
        key: ${{ github.job }}-${{ runner.os }}-${{ hashFiles( 'bootstrap', 'patches/**' ) }}
    - name: Install package dependencies
      run: |
        sudo apt-get update
        sudo apt-get install \
            doxygen \
            graphviz \
            help2man \
            python3-docutils \
            pngcrush \
            python3-sphinx \
            uuid-dev
    - name: bootstrap source tree
      run: |
        # If we restored cached bootstrap tools their timestamps will be older
        # than checked out files, but we stored them based on a hash of the
        # files in git that determine what gets built so we know they are in
        # fact up to date.  Just touch any stamp files that exist.
        touch --no-create INST/*.stamp
        export PATH=/usr/lib/ccache:$PATH
        echo verbose=off > ~/.wgetrc
        ./bootstrap xapian-core xapian-letor
    - name: configure
      run: ./configure CC='ccache gcc' CXX='ccache g++' CFLAGS=-O0 CXXFLAGS=-O0
    - name: make
      run: make -j2
    - name: Create distribution tarball
      run: |
        make dist
    - uses: actions/upload-artifact@v4
      with:
        path: |
          xapian-core/xapian-core-*.tar.xz
          xapian-letor/xapian-letor-*.tar.xz
        # Files are already compressed so don't try to compress again.
        compression-level: 0
        retention-days: 1
        if-no-files-found: error
    - name: Check generated files are in .gitignore
      # grep '^' passes through all input while giving a non-zero exit status
      # if that input is empty.
      run: git status --porcelain|grep '^' && { echo "The generated files listed above are not in .gitignore" ; exit 1; }; true

  mingw64-i686-cross:
    runs-on: 'ubuntu-22.04'
    needs: makedist
    steps:
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
    - name: Fetch distribution
      uses: actions/download-artifact@v4
    - name: Unpack distribution
      run: |
        mv artifact/* .
        rmdir artifact
        pushd xapian-core
        tar --strip-components=1 -xf xapian-core-*.tar.xz
        popd
        pushd xapian-letor
        tar --strip-components=1 -xf xapian-letor-*.tar.xz
        popd
    - name: Install package dependencies
      run: |
        sudo apt-get update
        sudo apt-get install \
            g++-mingw-w64-i686-win32 \
            mingw-w64-i686-dev \
            binutils-mingw-w64-i686 \
            libz-mingw-w64-dev \
            mingw-w64-tools
    - name: configure
      run: |
        export EATMYDATA=
        export PATH=/usr/lib/ccache:$PATH
        pushd xapian-core
        ./configure --enable-werror --host i686-w64-mingw32
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        pushd xapian-letor
        ./configure --enable-werror --host i686-w64-mingw32
        popd
    - name: make
      run: |
        export PATH=/usr/lib/ccache:$PATH
        make -j2 -C xapian-core
        make -j2 -C xapian-letor
    - name: Run tests
      run: |
        # Stop mono binfmt trying to run .exe files.
        sudo apt-get purge mono-runtime
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install wine32 wine-binfmt:amd64 wine:amd64
        export AUTOMATED_TESTING=1
        export VERBOSE=1
        export WINEPATH="$PWD/xapian-core/.libs;/usr/lib/gcc/i686-w64-mingw32/`i686-w64-mingw32-g++ --version 2>/dev/null|head -n1|sed 's/.*) //;s/ .*//'`"
        make -j2 -C xapian-core check
        export WINEPATH="$PWD/xapian-letor/.libs;$WINEPATH"
        make -j2 -C xapian-letor check

  mingw64-x86-64-cross:
    runs-on: 'ubuntu-22.04'
    needs: makedist
    steps:
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
    - name: Fetch distribution
      uses: actions/download-artifact@v4
    - name: Unpack distribution
      run: |
        mv artifact/* .
        rmdir artifact
        pushd xapian-core
        tar --strip-components=1 -xf xapian-core-*.tar.xz
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        pushd xapian-letor
        tar --strip-components=1 -xf xapian-letor-*.tar.xz
        popd
    - name: Install package dependencies
      run: |
        sudo apt-get update
        # Stop mono binfmt trying to run .exe files.
        sudo apt-get purge mono-runtime
        sudo apt-get install \
            g++-mingw-w64-x86-64-win32 \
            mingw-w64-x86-64-dev \
            binutils-mingw-w64-x86-64 \
            libz-mingw-w64-dev \
            mingw-w64-tools \
            wine-binfmt \
            wine \
            wine64
        sudo dpkg --add-architecture i386
        sudo apt-get update
        sudo apt-get install wine32
    - name: configure
      run: |
        export EATMYDATA=
        export PATH=/usr/lib/ccache:$PATH
        pushd xapian-core
        ./configure --enable-werror --host x86_64-w64-mingw32
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        pushd xapian-letor
        ./configure --enable-werror --host x86_64-w64-mingw32
        popd
    - name: make
      run: |
        export PATH=/usr/lib/ccache:$PATH
        make -j2 -C xapian-core
        make -j2 -C xapian-letor
    - name: Run tests
      run: |
        export AUTOMATED_TESTING=1
        export VERBOSE=1
        export WINEPATH="$PWD/xapian-core/.libs;/usr/lib/gcc/x86_64-w64-mingw32/`x86_64-w64-mingw32-g++ --version 2>/dev/null|head -n1|sed 's/.*) //;s/ .*//'`"
        make -j2 -C xapian-core check
        export WINEPATH="$PWD/xapian-letor/.libs;$WINEPATH"
        make -j2 -C xapian-letor check

  cygwin:
    # We only test 64-bit cygwin as 32-bit support has been dropped as of
    # Cygwin 3.4:
    # https://cygwin.com/pipermail/cygwin/2022-November/252542.html
    runs-on: 'windows-latest'
    needs: makedist
    defaults:
      run:
        # `-o incr` needed as GHA supplies shell fragments with DOS EOLs.
        shell: 'C:\tools\cygwin\bin\bash.EXE --noprofile --norc -e -o igncr -o pipefail {0}'
    steps:
    - name: Install Cygwin
      uses: egor-tensin/setup-cygwin@v4
      with:
        packages: gcc-g++ make file-devel libpcre2-devel zlib-devel perl
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
    - name: Fetch distribution
      uses: actions/download-artifact@v4
    - name: Unpack distribution
      run: |
        mv artifact/* .
        rmdir artifact
        pushd xapian-core
        tar --strip-components=1 -xf xapian-core-*.tar.xz
        popd
        pushd xapian-applications/omega
        tar --strip-components=1 -xf xapian-omega-*.tar.xz
        popd
        pushd xapian-bindings
        tar --strip-components=1 -xf xapian-bindings-*.tar.xz
        popd
        pushd xapian-letor
        tar --strip-components=1 -xf xapian-letor-*.tar.xz
        popd
    - name: configure
      run: |
        export CC='ccache gcc'
        export CXX='ccache g++'
        pushd xapian-core
        ./configure --enable-werror
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        pushd xapian-applications/omega
        ./configure --enable-werror
        popd
        # pushd xapian-bindings
        # ./configure --enable-werror
        # popd
        pushd xapian-letor
        ./configure --enable-werror
        popd
    - name: make
      run: |
        make -j2 -C xapian-core
        make -j2 -C xapian-applications/omega
        # make -j2 -C xapian-bindings
        make -j2 -C xapian-letor
    - name: Run tests
      run: |
        export AUTOMATED_TESTING=1
        export VERBOSE=1
        make -j2 -C xapian-core check
        make -j2 -C xapian-applications/omega check
        # make -j2 -C xapian-bindings check
        make -j2 -C xapian-letor check

  msys2-mingw32:
    runs-on: 'windows-latest'
    needs: makedist
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        msystem: mingw32
        install: base-devel
        pacboy: >-
          file:p
          gcc:p
          pcre2:p
          zlib:p
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
        variant: sccache
    - name: Fetch distribution
      uses: actions/download-artifact@v4
    - name: Unpack distribution
      run: |
        mv artifact/* .
        rmdir artifact
        pushd xapian-core
        tar --strip-components=1 -xf xapian-core-*.tar.xz
        popd
        pushd xapian-applications/omega
        tar --strip-components=1 -xf xapian-omega-*.tar.xz
        popd
        # pushd xapian-bindings
        # tar --strip-components=1 -xf xapian-bindings-*.tar.xz
        # popd
        pushd xapian-letor
        tar --strip-components=1 -xf xapian-letor-*.tar.xz
        popd
    - name: configure
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        export CC='sccache gcc'
        export CXX='sccache g++'
        pushd xapian-core
        ./configure --enable-werror
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        pushd xapian-applications/omega
        ./configure --enable-werror
        popd
        # pushd xapian-bindings
        # ./configure --enable-werror
        # popd
        pushd xapian-letor
        ./configure --enable-werror
        popd
    - name: make
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        make -j2 -C xapian-core
        make -j2 -C xapian-applications/omega
        # make -j2 -C xapian-bindings
        make -j2 -C xapian-letor
    - name: Run tests
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        export AUTOMATED_TESTING=1
        export VERBOSE=1
        make -j2 -C xapian-core check
        make -j2 -C xapian-applications/omega check
        # make -j2 -C xapian-bindings check
        make -j2 -C xapian-letor check

  msys2-mingw64:
    runs-on: 'windows-latest'
    needs: makedist
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        msystem: mingw64
        install: base-devel
        pacboy: >-
          file:p
          gcc:p
          pcre2:p
          zlib:p
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
        variant: sccache
    - name: Fetch distribution
      uses: actions/download-artifact@v4
    - name: Unpack distribution
      run: |
        mv artifact/* .
        rmdir artifact
        pushd xapian-core
        tar --strip-components=1 -xf xapian-core-*.tar.xz
        popd
        pushd xapian-applications/omega
        tar --strip-components=1 -xf xapian-omega-*.tar.xz
        popd
        # pushd xapian-bindings
        # tar --strip-components=1 -xf xapian-bindings-*.tar.xz
        # popd
        pushd xapian-letor
        tar --strip-components=1 -xf xapian-letor-*.tar.xz
        popd
    - name: configure
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        export CC='sccache gcc'
        export CXX='sccache g++'
        pushd xapian-core
        ./configure --enable-werror
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        pushd xapian-applications/omega
        ./configure --enable-werror
        popd
        # pushd xapian-bindings
        # ./configure --enable-werror
        # popd
        pushd xapian-letor
        ./configure --enable-werror
        popd
    - name: make
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        make -j2 -C xapian-core
        make -j2 -C xapian-applications/omega
        # make -j2 -C xapian-bindings
        make -j2 -C xapian-letor
    - name: Run tests
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        export AUTOMATED_TESTING=1
        export VERBOSE=1
        make -j2 -C xapian-core check
        make -j2 -C xapian-applications/omega check
        # make -j2 -C xapian-bindings check
        make -j2 -C xapian-letor check

  msys2-ucrt64:
    runs-on: 'windows-latest'
    needs: makedist
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        msystem: ucrt64
        install: base-devel
        pacboy: >-
          gcc:p
          zlib:p
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
        variant: sccache
    - name: Fetch distribution
      uses: actions/download-artifact@v4
    - name: Unpack distribution
      run: |
        mv artifact/* .
        rmdir artifact
        pushd xapian-core
        tar --strip-components=1 -xf xapian-core-*.tar.xz
        popd
        # pushd xapian-applications/omega
        # tar --strip-components=1 -xf xapian-omega-*.tar.xz
        # popd
        # pushd xapian-bindings
        # tar --strip-components=1 -xf xapian-bindings-*.tar.xz
        # popd
        pushd xapian-letor
        tar --strip-components=1 -xf xapian-letor-*.tar.xz
        popd
    - name: configure
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        export CC='sccache gcc'
        export CXX='sccache g++'
        pushd xapian-core
        ./configure --enable-werror
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        # FIXME: Fails to find magic.h for some reason even though it is
        # installed via file:p above.
        # pushd xapian-applications/omega
        # ./configure --enable-werror
        # popd
        # pushd xapian-bindings
        # ./configure --enable-werror
        # popd
        pushd xapian-letor
        ./configure --enable-werror
        popd
    - name: make
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        make -j2 -C xapian-core
        # make -j2 -C xapian-applications/omega
        # make -j2 -C xapian-bindings
        make -j2 -C xapian-letor
    - name: Run tests
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        export AUTOMATED_TESTING=1
        export VERBOSE=1
        make -j2 -C xapian-core check
        # make -j2 -C xapian-applications/omega check
        # make -j2 -C xapian-bindings check
        make -j2 -C xapian-letor check

  msvc2019:
    runs-on: 'windows-2019'
    needs: makedist
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        release: true # Use the pre-installed MSYS2
        path-type: inherit
        install: base-devel
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
        variant: sccache
    - name: Fetch distribution
      uses: actions/download-artifact@v4
    - name: Unpack distribution
      run: |
        mv artifact/* .
        rmdir artifact
        pushd xapian-core
        tar --strip-components=1 -xf xapian-core-*.tar.xz
        popd
        # Need libmagic for omega
        # pushd xapian-applications/omega
        # tar --strip-components=1 -xf xapian-omega-*.tar.xz
        # popd
        # pushd xapian-bindings
        # tar --strip-components=1 -xf xapian-bindings-*.tar.xz
        # popd
        pushd xapian-letor
        tar --strip-components=1 -xf xapian-letor-*.tar.xz
        popd
    - name: Set up Visual Studio shell
      uses: egor-tensin/vs-shell@v2
      with:
        arch: x64
    - name: Build zlib
      shell: bash
      run: |
        # Setup sccache for cl.
        ln /c/Users/runneradmin/.cargo/bin/{sccache.exe,cl.exe}
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        # We find "link" from coreutils rather than from MSVC.  The coreutils
        # "link" is not a useful tool to us, so just delete it rather than
        # trying to reorder PATH.
        rm /usr/bin/link.exe || true
        mkdir zlib
        pushd zlib
        curl --retry 5 --retry-connrefused -L https://github.com/xapian/xapian-dev-deps/releases/download/current/zlib-1.2.13.tar.gz|tar --strip-components=1 -zxf -
        # Don't build zlib with -MD as it seems this flag needs to be used
        # consistently across the build.  Don't use -Zi -Fd"zlib" as
        # ccache/sccache don't seem to be able to handle that.
        #
        # Don't build zlib with a fixed base address on x64 as that gives
        # linker warning LNK4281.
        sed -i 's/\(^CFLAGS  *= *-nologo \)-MD \(.* \)-Zi -Fd"zlib" /\1\2/;s/-base:0x[0-9A-Fa-f]* //' win32/Makefile.msc
        # Only build the shared library.
        nmake -nologo -f 'win32\Makefile.msc' zlib1.dll
        popd
    - name: configure
      run: |
        export AR=lib
        export CC="cl -nologo"
        export CXX="$PWD/xapian-core/compile cl -nologo"
        export CPPFLAGS="-I$PWD/zlib"
        # Standard C++ stack unwinding; assume extern "C" functions never throw.
        export CXXFLAGS=-EHsc
        export LD="link"
        export LDFLAGS="-L$PWD/zlib"
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        pushd xapian-core
        ./configure --enable-werror # --disable-shared
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        # pushd xapian-applications/omega
        # ./configure --enable-werror
        # popd
        # pushd xapian-bindings
        # ./configure --enable-werror
        # popd
        pushd xapian-letor
        ./configure --enable-werror # --disable-shared
        popd
    - name: make
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        make -j2 -C xapian-core
        # make -j2 -C xapian-applications/omega
        # make -j2 -C xapian-binding
        make -j2 -C xapian-letor
    - name: Run tests
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        export AUTOMATED_TESTING=1
        export VERBOSE=1
        make -j2 -C xapian-core check
        # make -j2 -C xapian-applications/omega check
        # make -j2 -C xapian-bindings check
        make -j2 -C xapian-letor check

  msvc2022:
    runs-on: 'windows-2022'
    needs: makedist
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        release: true # Use the pre-installed MSYS2
        path-type: inherit
        install: base-devel
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
        variant: sccache
    - name: Fetch distribution
      uses: actions/download-artifact@v4
    - name: Unpack distribution
      run: |
        mv artifact/* .
        rmdir artifact
        pushd xapian-core
        tar --strip-components=1 -xf xapian-core-*.tar.xz
        popd
        # Need libmagic for omega
        # pushd xapian-applications/omega
        # tar --strip-components=1 -xf xapian-omega-*.tar.xz
        # popd
        # pushd xapian-bindings
        # tar --strip-components=1 -xf xapian-bindings-*.tar.xz
        # popd
        pushd xapian-letor
        tar --strip-components=1 -xf xapian-letor-*.tar.xz
        popd
    - name: Set up Visual Studio shell
      uses: egor-tensin/vs-shell@v2
      with:
        arch: x64
    - name: Build zlib
      shell: bash
      run: |
        # Setup sccache for cl.
        ln /c/Users/runneradmin/.cargo/bin/{sccache.exe,cl.exe}
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        # We find "link" from coreutils rather than from MSVC.  The coreutils
        # "link" is not a useful tool to us, so just delete it rather than
        # trying to reorder PATH.
        rm /usr/bin/link.exe || true
        mkdir zlib
        pushd zlib
        curl --retry 5 --retry-connrefused -L https://github.com/xapian/xapian-dev-deps/releases/download/current/zlib-1.2.13.tar.gz|tar --strip-components=1 -zxf -
        # Don't build zlib with -MD as it seems this flag needs to be used
        # consistently across the build.  Don't use -Zi -Fd"zlib" as
        # ccache/sccache don't seem to be able to handle that.
        #
        # Don't build zlib with a fixed base address on x64 as that gives
        # linker warning LNK4281.
        sed -i 's/\(^CFLAGS  *= *-nologo \)-MD \(.* \)-Zi -Fd"zlib" /\1\2/;s/-base:0x[0-9A-Fa-f]* //' win32/Makefile.msc
        # Only build the shared library.
        nmake -nologo -f 'win32\Makefile.msc' zlib1.dll
        popd
    - name: configure
      run: |
        export AR=lib
        export CC="cl -nologo"
        export CXX="$PWD/xapian-core/compile cl -nologo"
        export CPPFLAGS="-I$PWD/zlib"
        # Standard C++ stack unwinding; assume extern "C" functions never throw.
        export CXXFLAGS=-EHsc
        export LD="link"
        export LDFLAGS="-L$PWD/zlib"
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        pushd xapian-core
        ./configure --enable-werror # --disable-shared
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        # pushd xapian-applications/omega
        # ./configure --enable-werror
        # popd
        # pushd xapian-bindings
        # ./configure --enable-werror
        # popd
        pushd xapian-letor
        ./configure --enable-werror # --disable-shared
        popd
    - name: make
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        make -j2 -C xapian-core
        # make -j2 -C xapian-applications/omega
        # make -j2 -C xapian-binding
        make -j2 -C xapian-letor
    - name: Run tests
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        export AUTOMATED_TESTING=1
        export VERBOSE=1
        make -j2 -C xapian-core check
        # make -j2 -C xapian-applications/omega check
        # make -j2 -C xapian-bindings check
        make -j2 -C xapian-letor check

  msvc2019-x86:
    runs-on: 'windows-2019'
    needs: makedist
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        release: true # Use the pre-installed MSYS2
        path-type: inherit
        install: base-devel
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
        variant: sccache
    - name: Fetch distribution
      uses: actions/download-artifact@v4
    - name: Unpack distribution
      run: |
        mv artifact/* .
        rmdir artifact
        pushd xapian-core
        tar --strip-components=1 -xf xapian-core-*.tar.xz
        popd
        # Need libmagic for omega
        # pushd xapian-applications/omega
        # tar --strip-components=1 -xf xapian-omega-*.tar.xz
        # popd
        # pushd xapian-bindings
        # tar --strip-components=1 -xf xapian-bindings-*.tar.xz
        # popd
        pushd xapian-letor
        tar --strip-components=1 -xf xapian-letor-*.tar.xz
        popd
    - name: Set up Visual Studio shell
      uses: egor-tensin/vs-shell@v2
      with:
        arch: x86
    - name: Build zlib
      shell: bash
      run: |
        # Setup sccache for cl.
        ln /c/Users/runneradmin/.cargo/bin/{sccache.exe,cl.exe}
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        # We find "link" from coreutils rather than from MSVC.  The coreutils
        # "link" is not a useful tool to us, so just delete it rather than
        # trying to reorder PATH.
        rm /usr/bin/link.exe || true
        mkdir zlib
        pushd zlib
        curl --retry 5 --retry-connrefused -L https://github.com/xapian/xapian-dev-deps/releases/download/current/zlib-1.2.13.tar.gz|tar --strip-components=1 -zxf -
        # Don't build zlib with -MD as it seems this flag needs to be used
        # consistently across the build.  Don't use -Zi -Fd"zlib" as
        # ccache/sccache don't seem to be able to handle that.
        sed -i 's/\(^CFLAGS  *= *-nologo \)-MD \(.* \)-Zi -Fd"zlib" /\1\2/' win32/Makefile.msc
        # Only build the static library.
        nmake -nologo -f 'win32\Makefile.msc' zlib1.dll
        popd
    - name: configure
      run: |
        export AR=lib
        export CC="cl -nologo"
        export CXX="$PWD/xapian-core/compile cl -nologo"
        export CPPFLAGS="-I$PWD/zlib"
        # Standard C++ stack unwinding; assume extern "C" functions never throw.
        export CXXFLAGS=-EHsc
        export LD="link"
        export LDFLAGS="-L$PWD/zlib"
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        pushd xapian-core
        ./configure --enable-werror # --disable-shared
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        # pushd xapian-applications/omega
        # ./configure --enable-werror
        # popd
        # pushd xapian-bindings
        # ./configure --enable-werror
        # popd
        pushd xapian-letor
        ./configure --enable-werror # --disable-shared
        popd
    - name: make
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        make -j2 -C xapian-core
        # make -j2 -C xapian-applications/omega
        # make -j2 -C xapian-binding
        make -j2 -C xapian-letor
    - name: Run tests
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        export AUTOMATED_TESTING=1
        export VERBOSE=1
        make -j2 -C xapian-core check
        # make -j2 -C xapian-applications/omega check
        # make -j2 -C xapian-bindings check
        make -j2 -C xapian-letor check

  msvc2022-x86:
    runs-on: 'windows-2022'
    needs: makedist
    defaults:
      run:
        shell: msys2 {0}
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        release: true # Use the pre-installed MSYS2
        path-type: inherit
        install: base-devel
    - name: Install CCache
      uses: hendrikmuhs/ccache-action@v1
      with:
        key: ${{ github.job }}
        variant: sccache
    - name: Fetch distribution
      uses: actions/download-artifact@v4
    - name: Unpack distribution
      run: |
        mv artifact/* .
        rmdir artifact
        pushd xapian-core
        tar --strip-components=1 -xf xapian-core-*.tar.xz
        popd
        # Need libmagic for omega
        # pushd xapian-applications/omega
        # tar --strip-components=1 -xf xapian-omega-*.tar.xz
        # popd
        # pushd xapian-bindings
        # tar --strip-components=1 -xf xapian-bindings-*.tar.xz
        # popd
        pushd xapian-letor
        tar --strip-components=1 -xf xapian-letor-*.tar.xz
        popd
    - name: Set up Visual Studio shell
      uses: egor-tensin/vs-shell@v2
      with:
        arch: x86
    - name: Build zlib
      shell: bash
      run: |
        # Setup sccache for cl.
        ln /c/Users/runneradmin/.cargo/bin/{sccache.exe,cl.exe}
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        # We find "link" from coreutils rather than from MSVC.  The coreutils
        # "link" is not a useful tool to us, so just delete it rather than
        # trying to reorder PATH.
        rm /usr/bin/link.exe || true
        mkdir zlib
        pushd zlib
        curl --retry 5 --retry-connrefused -L https://github.com/xapian/xapian-dev-deps/releases/download/current/zlib-1.2.13.tar.gz|tar --strip-components=1 -zxf -
        # Don't build zlib with -MD as it seems this flag needs to be used
        # consistently across the build.  Don't use -Zi -Fd"zlib" as
        # ccache/sccache don't seem to be able to handle that.
        sed -i 's/\(^CFLAGS  *= *-nologo \)-MD \(.* \)-Zi -Fd"zlib" /\1\2/' win32/Makefile.msc
        # Only build the static library.
        nmake -nologo -f 'win32\Makefile.msc' zlib1.dll
        popd
    - name: configure
      run: |
        export AR=lib
        export CC="cl -nologo"
        export CXX="$PWD/xapian-core/compile cl -nologo"
        export CPPFLAGS="-I$PWD/zlib"
        # Standard C++ stack unwinding; assume extern "C" functions never throw.
        export CXXFLAGS=-EHsc
        export LD="link"
        export LDFLAGS="-L$PWD/zlib"
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        pushd xapian-core
        ./configure --enable-werror # --disable-shared
        export XAPIAN_CONFIG=$PWD/xapian-config
        popd
        # pushd xapian-applications/omega
        # ./configure --enable-werror
        # popd
        # pushd xapian-bindings
        # ./configure --enable-werror
        # popd
        pushd xapian-letor
        ./configure --enable-werror # --disable-shared
        popd
    - name: make
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        make -j2 -C xapian-core
        # make -j2 -C xapian-applications/omega
        # make -j2 -C xapian-binding
        make -j2 -C xapian-letor
    - name: Run tests
      run: |
        PATH=/c/Users/runneradmin/.cargo/bin:$PATH
        export AUTOMATED_TESTING=1
        export VERBOSE=1
        make -j2 -C xapian-core check
        # make -j2 -C xapian-applications/omega check
        # make -j2 -C xapian-bindings check
        make -j2 -C xapian-letor check
