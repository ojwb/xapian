name: CI

on:
  push:
    paths-ignore:
      - '.appveyor.yml'
      - NEWS
      - 'xapian-maintainer-tools/**'
  pull_request:
    branches: master
    paths-ignore:
      - '.appveyor.yml'
      - NEWS
      - 'xapian-maintainer-tools/**'

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  windows:
    runs-on: 'windows-latest'
    steps:
    - name: Check out repository code
      uses: actions/checkout@v3
    - name: Set up Visual Studio shell
      uses: egor-tensin/vs-shell@v2
      with:
        arch: x64
    - name: Install package dependencies
      run: |
        pacman install make wget autoconf automake libtool
        #choco install gnuwin32-m4 make wget
    - name: bootstrap source tree
      run: |
        echo verbose=off > ~/.wgetrc
        bash -c ./bootstrap xapian-core
    - name: configure
      run: bash -c ./configure CC='cl -nologo' CXX='ccache g++'
    - name: make
      run: make -j2
    - name: Run tests
      run: make -j2 check VERBOSE=1 AUTOMATED_TESTING=1
